name: Craft CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  validate:
    name: Validate Plugin Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Check required files
        run: |
          test -f .claude-plugin/plugin.json || { echo "Missing plugin.json"; exit 1; }
          test -f README.md || { echo "Missing README.md"; exit 1; }
          test -x install.sh || { echo "Missing or non-executable install.sh"; exit 1; }
          test -x scripts/uninstall.sh || { echo "Missing or non-executable uninstall.sh"; exit 1; }
          echo "âœ… All required files present"

      - name: Validate plugin.json
        run: |
          # Check if jq is available
          if ! command -v jq &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

          # Validate JSON syntax
          jq empty .claude-plugin/plugin.json || { echo "âŒ Invalid JSON in plugin.json"; exit 1; }

          # Check plugin name
          PLUGIN_NAME=$(jq -r '.name' .claude-plugin/plugin.json)
          if [[ "$PLUGIN_NAME" != "craft" ]]; then
            echo "âŒ Plugin name should be 'craft', got: $PLUGIN_NAME"
            exit 1
          fi

          # Check version exists
          VERSION=$(jq -r '.version' .claude-plugin/plugin.json)
          if [[ -z "$VERSION" || "$VERSION" == "null" ]]; then
            echo "âŒ Plugin version is missing"
            exit 1
          fi

          echo "âœ… plugin.json is valid (name: $PLUGIN_NAME, version: $VERSION)"

      - name: Check directory structure
        run: |
          test -d commands || { echo "âŒ Missing commands/ directory"; exit 1; }
          test -d skills || { echo "âŒ Missing skills/ directory"; exit 1; }
          test -d agents || { echo "âŒ Missing agents/ directory"; exit 1; }
          test -d docs || { echo "âŒ Missing docs/ directory"; exit 1; }
          test -d scripts || { echo "âŒ Missing scripts/ directory"; exit 1; }
          test -d tests || { echo "âŒ Missing tests/ directory"; exit 1; }
          echo "âœ… All required directories present"

      - name: Validate command count
        run: |
          COMMAND_COUNT=$(find commands -name "*.md" -type f | wc -l | tr -d ' ')
          if [ "$COMMAND_COUNT" -lt 86 ]; then
            echo "âŒ Expected at least 86 commands, found $COMMAND_COUNT"
            exit 1
          fi
          echo "âœ… Found $COMMAND_COUNT command files"

      - name: Check skills
        run: |
          SKILL_COUNT=$(find skills -name "*.md" -type f | wc -l | tr -d ' ')
          if [ "$SKILL_COUNT" -lt 21 ]; then
            echo "âŒ Expected at least 21 skills, found $SKILL_COUNT"
            exit 1
          fi
          echo "âœ… Found $SKILL_COUNT skill files"

      - name: Check agents
        run: |
          test -f agents/orchestrator.md || { echo "âŒ Missing orchestrator agent"; exit 1; }
          test -f agents/orchestrator-v2.md || { echo "âŒ Missing orchestrator-v2 agent"; exit 1; }
          echo "âœ… All agent files present"

      - name: Check for hardcoded paths
        run: |
          HARDCODED_PATHS=0
          # Exclude CLAUDE_PLUGIN_ROOT references and CI example documentation
          if grep -r "/Users/" commands skills agents 2>/dev/null | grep -v "CLAUDE_PLUGIN_ROOT" | grep -v -E "(grep|echo).*Users"; then
            echo "âŒ Found hardcoded /Users/ paths"
            HARDCODED_PATHS=1
          fi
          if grep -r "/home/" commands skills agents 2>/dev/null | grep -v "CLAUDE_PLUGIN_ROOT" | grep -v -E "(grep|echo).*home"; then
            echo "âŒ Found hardcoded /home/ paths"
            HARDCODED_PATHS=1
          fi
          if [ $HARDCODED_PATHS -eq 0 ]; then
            echo "âœ… No hardcoded paths found"
          else
            exit 1
          fi

      - name: Run test suite
        run: |
          python -m pytest tests/ -v --tb=short

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All CI checks passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Summary:"
          COMMAND_COUNT=$(find commands -name "*.md" -type f | wc -l | tr -d ' ')
          SKILL_COUNT=$(find skills -name "*.md" -type f | wc -l | tr -d ' ')
          echo "  - Commands: $COMMAND_COUNT"
          echo "  - Skills: $SKILL_COUNT"
          echo "  - Agents: 8+"
          echo "  - Structure: Full-stack developer toolkit"
