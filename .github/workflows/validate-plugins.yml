name: Validate Plugins

on:
  push:
    branches: [ main, dev ]
    paths:
      - 'craft/**'
      - 'rforge-orchestrator/**'
      - 'statistical-research/**'
      - 'workflow/**'
      - '.github/workflows/**'
      - 'scripts/**'
  pull_request:
    branches: [ main, dev ]
    paths:
      - 'craft/**'
      - 'rforge-orchestrator/**'
      - 'statistical-research/**'
      - 'workflow/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        plugin:
          - craft
          - rforge-orchestrator
          - statistical-research
          - workflow

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Validate plugin structure
        run: |
          cd ${{ matrix.plugin }}

          # Check required files
          test -f .claude-plugin/plugin.json || (echo "❌ Missing plugin.json" && exit 1)
          test -f package.json || (echo "❌ Missing package.json" && exit 1)
          test -f README.md || (echo "❌ Missing README.md" && exit 1)
          test -f LICENSE || (echo "❌ Missing LICENSE" && exit 1)

          echo "✅ Required files present"

      - name: Validate package.json
        run: |
          cd ${{ matrix.plugin }}

          # Check package.json is valid JSON
          python3 -m json.tool package.json > /dev/null || (echo "❌ Invalid JSON in package.json" && exit 1)

          # Check required fields
          node -e "
            const pkg = JSON.parse(require('fs').readFileSync('package.json', 'utf8'));
            const required = ['name', 'version', 'description', 'license', 'repository'];
            for (const field of required) {
              if (!pkg[field]) throw new Error('Missing required field: ' + field);
            }
            console.log('✅ package.json has all required fields');
          "

      - name: Validate plugin.json
        run: |
          cd ${{ matrix.plugin }}

          # Check plugin.json is valid JSON
          python3 -m json.tool .claude-plugin/plugin.json > /dev/null || (echo "❌ Invalid JSON in plugin.json" && exit 1)

          # Check required fields
          node -e "
            const plugin = JSON.parse(require('fs').readFileSync('.claude-plugin/plugin.json', 'utf8'));
            const required = ['name', 'version', 'description'];
            for (const field of required) {
              if (!plugin[field]) throw new Error('Missing required field: ' + field);
            }
            console.log('✅ plugin.json has all required fields');
          "

      - name: Validate command structure
        run: |
          cd ${{ matrix.plugin }}

          # Check command files have proper structure
          if [ -d commands ]; then
            echo "Checking command structure..."
            python3 << 'EOF'
          import re
          from pathlib import Path

          commands_dir = Path('commands')
          issues = []
          total = 0

          for cmd_file in commands_dir.rglob('*.md'):
              total += 1
              with open(cmd_file, 'r') as f:
                  content = f.read(2000)

              has_frontmatter = content.startswith('---')
              # Check for any markdown heading
              has_heading = bool(re.search(r'^#\s+.+', content, re.MULTILINE))

              # Command must have either frontmatter OR a heading
              if not has_frontmatter and not has_heading:
                  issues.append(str(cmd_file))

          if issues:
              print(f"❌ {len(issues)} command files missing structure:")
              for f in issues[:5]:
                  print(f"   - {f}")
              exit(1)
          else:
              print(f"✅ All {total} command files have valid structure")
          EOF
          else
            echo "⚠️  No commands directory (skipping)"
          fi

      - name: Check for hardcoded paths
        run: |
          cd ${{ matrix.plugin }}

          # Check for common hardcoded paths
          errors=0

          if grep -r "/Users/" commands/ lib/ 2>/dev/null; then
            echo "❌ Found hardcoded /Users/ paths"
            errors=1
          fi

          if grep -r "/home/" commands/ lib/ 2>/dev/null; then
            echo "❌ Found hardcoded /home/ paths"
            errors=1
          fi

          if [ $errors -eq 0 ]; then
            echo "✅ No hardcoded paths found"
          else
            exit 1
          fi

      - name: Check for broken links in README
        run: |
          cd ${{ matrix.plugin }}

          # Simple check for obvious broken links
          if grep -E '\[.*\]\(http.*\)' README.md | grep -E '\(http.*404\)'; then
            echo "⚠️  Potential broken links detected"
          else
            echo "✅ No obvious broken links in README"
          fi

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ ${{ matrix.plugin }} validation complete"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

  comprehensive-validation:
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Run comprehensive validation
        run: |
          if [ -f scripts/validate-all-plugins.py ]; then
            echo "Running comprehensive validation..."
            python3 scripts/validate-all-plugins.py
          else
            echo "⚠️  Comprehensive validation script not found (skipping)"
          fi

      - name: Final summary
        if: success()
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ ALL PLUGINS VALIDATED SUCCESSFULLY"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Validated plugins:"
          echo "  ✅ craft"
          echo "  ✅ rforge-orchestrator"
          echo "  ✅ statistical-research"
          echo "  ✅ workflow"
          echo ""
